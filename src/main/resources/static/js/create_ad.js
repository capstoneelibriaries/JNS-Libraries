console.log("Running create ad.js");

const form = {
    create: "#create-ad",
    price: {
        label: "#ad-price",
        field: "#create-ad-price",
    },
    shipping: {
        label: "#ad-shipping",
        field: "#create-ad-shipping",
    },
    tradable: {
        label: "#ad-tradable",
        field: "#create-ad-tradable",
    },
    newBook: {
        label: "#ad-new-book",
        button: "#btn-ad-new-book",
        form: "#ad-new-book-form",
    },
    submit: {
        label: "#ad-submit-all",
        button: "#btn-ad-submit-all",
    }
};
// constants that control html elements generated by jquery
const isbn_min = 10;
const isbn_max = 13;
// book forms are pushed to this array
let bookForms = [];

// book object constructor that creates a book from the openbook
// api response
// const newBookFrom = (openbook) => {
//     let authors = "";
//     openbook.authors.forEach( (author) => {
//        authors += author.name + ", ";
//     });
//
//     let self = {
//         isbn: openbook.isbn,
//         title: openbook.title,
//         author: authors,
//         synopsis: openbook.excerpts[0].text,
//     };
//     return self;
// };

const isbnToHtml = (bookForm) => {
    return `` +
    `<section id=${bookForm.section}>` +
        `<label for="${bookForm.isbn}">ISBN</label>` +
        `<input id="${bookForm.isbn}" type="number" minlength="${isbn_min}" maxlength="${isbn_max}" name="${bookForm.isbn}" />` +
    `</section>`;
};

const bookFormToHtml = (bookForm) => {
    return `` +
    `<section>` +
        `<div>` +
            `<label for="${bookForm.title}">Title</label>` +
            `<input id="${bookForm.title}" name="${bookForm.title}" />` +
        `</div>` +
        `<div>` +
            `<label for="${bookForm.author}">Author</label>` +
            `<input id="${bookForm.author}" name="${bookForm.author}" />` +
        `</div>` +
        `<div>` +
            `<label for="${bookForm.synopsis}">Synopsis</label>` +
            `<input id="${bookForm.synopsis}" name="${bookForm.synopsis}" />` +
        `</div>` +
        `<div>` +
            `<label for="${bookForm.wear}">Condition</label>` +
            `<input id="${bookForm.wear}" name="${bookForm.wear}" />` +
        `</div>` +
    `</section>`
};

const autoFill = (bookForm) => {

    const isbn = $(bookForm.isbn).val();
    let apiResponse = {};

    $.ajax({
        'url': `https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&jscmd=data&format=json`,
        'type': 'GET',
        'success': (data) => {
            apiResponse = data[`ISBN:${isbn}`];
            apiResponse.isbn = isbn;
            //let book = newBookFrom(apiResponse);
            let book = Book.from(apiResponse);
            // console.log(apiResponse);
            $(bookForm.title).val(book.title);
            $(bookForm.author).val(book.author);
            $(bookForm.synopsis).val(book.synopsis);
        },
        'error': (request, error) => {
            console.log("Request: " + JSON.stringify(request));
        }
    });
};

const newBookForm = (index) => {
  let self = {
      section: `new-book-${index}`,
      isbn: `new-book-${index}-isbn`,
      title: `new-book-${index}-title`,
      author: `new-book-${index}-author`,
      synopsis: `new-book-${index}-wear`,
      wear: `new-book-${index}-wear`,
  };
  return self;
}

const generateISBN = (event) => {

    // create a form object for each book
    let bookForm = newBookForm(bookForms.length);

    // append a new html section to the form
    $(form.newBook.form).append(isbnToHtml(bookForm));

    // alter the strings on section and isbn for jquery selection
    bookForm.section = `#${bookForm.section}`;
    bookForm.isbn = `#${bookForm.isbn}`;

    // ad the form to an array of forms
    bookForms.push(bookForm);

    // only append to the form once
    let generatedForms = 0;
    // create the isbn out here, so it isn't being re-instantiated
    let isbn = "";

    $(bookForm.isbn).on("keyup", (event) => {
       isbn = $(bookForm.isbn).val();
       if(isbn.length >= isbn_min && generatedForms < 1){
           $(bookForm.section).append(bookFormToHtml(bookForm));
           // convert the values of book form so they can be selected by jquery
           bookForm.title = `#${bookForm.title}`;
           bookForm.author = `#${bookForm.author}`;
           bookForm.synopsis = `#${bookForm.synopsis}`;
           bookForm.wear = `#${bookForm.wear}`;
           generatedForms++;
           autoFill(Object.freeze(bookForm));
       }
    });
};

$(form.newBook.button).on("click", (event) => generateISBN(event));;
